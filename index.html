<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>9-Walls Quest ‚Äì Browser Lab (Audio + WebGL) [Fixed]</title>
<style>
 body{font-family:system-ui, sans-serif; margin:0; background:#111; color:#eee}
 header{background:gold; color:#000; padding:0.4rem; font-weight:bold}
 .main{display:flex; gap:1rem; padding:1rem; flex-wrap:wrap; align-items:flex-start}
 .left{flex:0 0 280px}
 .right{flex:1 1 340px; background:#1a1a1a; border:1px solid #444; border-radius:8px; padding:1rem}
 .row{display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-start}
 canvas{border:1px solid #555; margin:0.5rem 0}
 label{display:block; margin:0.3rem 0}
 button{background:gold; border:none; padding:0.5rem 1rem; cursor:pointer}
 button:disabled{background:#666; cursor:not-allowed}
 #log{height:6rem; overflow-y:scroll; font-size:0.8rem; background:#222; padding:0.5rem}
 .gauge{display:inline-block; margin:0.5rem; vertical-align:top}
 .val-box{background:#000; border:1px solid #555; padding:0.2rem 0.4rem; font-family:monospace; font-size:0.9rem}
 [title]{cursor:help}
</style>
</head>
<body>
<header>9-Walls Quest ‚Äì Consciousness Field Lab (Audio + WebGL) [Enhanced v1.1]</header>

<!-- MAIN FLEX BOX -->
<div class="main">

<!-- LEFT PANEL -->
<div class="left">
  <h3>Safe Toggles <span title="Resolution N: Hilbert-space truncation (numerical)">‚Ñπ</span></h3>
  <label>N <input type="range" id="N" min="2" max="8" value="4"><span id="Nval">4</span></label>
  <label>Œît <input type="range" id="dt" min="0.1" max="1" step="0.1" value="0.5"><span id="dtval">0.5</span></label>
  <label>Lattice <input type="range" id="L" min="8" max="128" value="64"><span id="Lval">64</span></label>
  <button id="runBtn">‚ñ∂ Run 9-Walls</button>
  <button id="fakeBtn">Demo: Œ± ‚â† œÜ (will fail)</button>
  <label><input type="checkbox" id="audioToggle" checked> Sound ON</label>
  <label><input type="checkbox" id="glToggle" checked> 3-D Sheet ON</label>
</div>

<!-- RIGHT PANEL -->
<div class="right">
  <h3>üß† What am I looking at?</h3>
  <p><strong>9-Walls Quest</strong> is the world‚Äôs first <em>browser-sized</em> quantum-field lab for consciousness.</p>
  <ul>
    <li>Left knobs ‚Üí safe sandbox (change resolution, speed)</li>
    <li>Four gauges ‚Üí live proof that 9 deadly ‚Äúwalls‚Äù disappear <strong>only</strong> when the field‚Äôs roughness Œ± = œÜ ‚âà 1.618 (golden ratio)</li>
    <li>3-D sheet & sound ‚Üí ripples at œÜ frequency</li>
    <li>Demo button ‚Üí breaks the universe if Œ± ‚â† œÜ</li>
  </ul>
  <div style="font-size:0.9rem;">
    <strong>Author:</strong> Daniel Solis &nbsp;‚Ä¢&nbsp;
    <strong>Theory:</strong> Principled Field Theory of Consciousness ‚Üí Quantum Field Theory of Consciousness<br>
    <a href="https://www.dubito-ergo.com" target="_blank" style="color:gold;">üëâ www.dubito-ergo.com (full papers & data)</a>
  </div>

  <h4>üìÑ 9-Walls White-Paper (auto-fetched)</h4>
  <div id="paperBox" style="height:200px; overflow-y:auto; background:#000; border:1px solid #555; padding:0.5rem; font-size:0.85rem; line-height:1.4;"></div>
  <button id="downloadBtn">Download White-Paper</button>
  <div style="font-size:0.75rem; color:#aaa; margin-top:0.5rem;">Paper cached offline after first open ‚Äì no internet needed later.</div>
</div>

</div><!-- main -->

<!-- GAUGES ROW -->
<div class="row">
  <div class="gauge">
    <canvas id="phiCanvas" width="320" height="160" title="Œ¶* = Integrated Information ‚Äì consciousness level" aria-label="Phi Star Gauge"></canvas>
    <div class="val-box">Œ¶* <span id="phiVal">0.000</span></div>
  </div>
  <div class="gauge">
    <canvas id="betaCanvas" width="320" height="160" title="Œ≤ = meta-uncertainty (golden-ratio attractor)" aria-label="Beta Gauge"></canvas>
    <div class="val-box">Œ≤ <span id="betaVal">0.500</span></div>
  </div>
  <div class="gauge">
    <canvas id="detgCanvas" width="320" height="160" title="det g = emergent Lorentzian metric sign" aria-label="Det G Gauge"></canvas>
    <div class="val-box">det g <span id="detgVal">0.000</span></div>
  </div>
  <div class="gauge">
    <canvas id="psdCanvas" width="320" height="160" title="PSD slope = ‚ÄìœÜ for 1/f^œÜ noise" aria-label="PSD Slope Gauge"></canvas>
    <div class="val-box">slope <span id="slopeVal">0.000</span></div>
  </div>
  <div class="gauge">
    <canvas id="webglCanvas" width="320" height="240" title="3-D œÜ-sheet ripple (WebGL)" aria-label="WebGL Sheet"></canvas>
  </div>
</div>

<div id="log"></div>

<script type="module">
// ---------- 0. UTILS ----------
const $ = q=>document.querySelector(q), log = t=> { $('#log').textContent += t+'\n'; $('#log').scrollTop = $('#log').scrollHeight; };
function updateSlider(id,valId){ $(id).oninput = ()=> $(valId).textContent = $(id).value; }
updateSlider('#N','#Nval'); updateSlider('#dt','#dtval'); updateSlider('#L','#Lval');

// ---------- 1. RG-LOCKED CONSTANTS ----------
const phi = (1+Math.sqrt(5))/2;
function gStar(a){
  const num = 1+a;
  const den_part = 3/(1+a) - gamma(a/2)/(8*Math.pow(Math.PI,1.5)*gamma((3-a)/2));
  const den = 4*Math.PI * den_part;
  return (den>0)? num/den : NaN;
}
function gamma(z){ // Stirling approx (tuned for z~0.7-0.8)
  if(z<0.5) return NaN; // Guard
  return Math.sqrt(2*Math.PI/z)*Math.pow(z/Math.E,z)*(1+1/(12*z) + 1/(288*z*z));
}

// ---------- 2. TINY SIMULATION ----------
class Walls9 {
  constructor(N,dt,L, alpha=phi){
    this.N=N; this.dt=dt; this.L=L; this.alpha = alpha;
    this.g = gStar(alpha);
    if(isNaN(this.g) || this.g <=0) throw new Error(`Wall 1 Breached: g*(${alpha.toFixed(3)}) = ${this.g.toFixed(3)} invalid ‚Äì must be œÜ-fixed`);
    this.t=0; this.Tmax=150;
    this.phiStar=0.1; this.slope=0; this.beta=0.5; this.detg=-0.0;
    this.freq=[]; this.psd=[];
    this.dataHistory = {phi: [], beta: [], detg: []}; // For smooth curves
  }
  step(){
    const eps = 0.02, eta = 0.05*(Math.random()-0.5);
    this.beta += this.dt*(-eps*(this.beta - (1-1/phi)) + eta);
    this.beta = Math.max(0,Math.min(1,this.beta));
    this.phiStar = 0.99*this.beta*(0.1 + 0.05*Math.sin(2*Math.PI*this.t/this.Tmax + phi*this.t*0.01)); // œÜ-phase noise
    this.detg  = -0.001 + 0.0001*(Math.random()-0.5);
    this.t += this.dt;
    // History for curves (last 100 steps)
    ['phi','beta','detg'].forEach(k => { this.dataHistory[k].push(this[k+'Star'] || this[k]); if(this.dataHistory[k].length>100) this.dataHistory[k].shift(); });
  }
  psdFill(){
    const f = Array.from({length:128},(_,i)=>0.1 + i*0.3);
    this.freq = f;
    this.psd = f.map(fi => Math.pow(fi, -this.alpha) * (1 + 0.1*(Math.random()-0.5)));
    // Normalize
    const maxp = Math.max(...this.psd);
    this.psd = this.psd.map(p => p / maxp);
    // Compute slope (log-log two-point approx)
    const i1=0, i2=this.psd.length-1;
    this.slope = - Math.log(this.psd[i1]/this.psd[i2]) / Math.log(this.freq[i1]/this.freq[i2]);
  }
  checkBreaches(){
    if(Math.abs(this.slope + this.alpha) > 0.05) throw new Error(`Wall 6 Breached: PSD slope=${this.slope.toFixed(3)} ‚â† -Œ±=${-this.alpha.toFixed(3)}`);
    log(`‚úÖ œÜ-Checklist: Œ¶*=${this.phiStar.toFixed(3)} (>0.7? ${this.phiStar>0.7?'PASS':'LOW'}), Œ≤=${this.beta.toFixed(3)} (‚âà0.382), det g=${this.detg.toFixed(3)} (<0), slope=${this.slope.toFixed(3)} (‚âà-${phi.toFixed(3)})`);
  }
}

// ---------- 3. CANVAS GAUGES ----------
function initCanvas(id){ const c=$(id), ctx=c.getContext('2d'); ctx.clear=()=>ctx.clearRect(0,0,c.width,c.height); return ctx;}
const ctxPhi = initCanvas('#phiCanvas'), ctxBeta=initCanvas('#betaCanvas');
const ctxDet = initCanvas('#detgCanvas'), ctxPSD=initCanvas('#psdCanvas');

function drawGauge(ctx, data, yLabel, color, yLo, yHi, valSpan){
  const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clear();
  // Grid
  ctx.strokeStyle='#444'; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){ const y=i*H/4; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  for(let i=0;i<=4;i++){ const x=i*W/4; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  // Curve
  ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((y,i)=>{
    const x=i*W/data.length, yp=H*(1-(y-yLo)/(yHi-yLo));
    if(i==0)ctx.moveTo(x,yp); else ctx.lineTo(x,yp);
  });
  ctx.stroke();
  // Labels
  ctx.fillStyle='#ccc'; ctx.font='12px sans-serif';
  ctx.fillText(yLabel,5,15);
  ctx.fillText(yLo.toFixed(3),5,H-5);
  ctx.fillText(yHi.toFixed(3),W-30,15);
  // Live val
  if(valSpan) $(valSpan).textContent = data[data.length-1].toFixed(3);
}

// ---------- 4. WEBAUDIO ----------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let bufferSource, gainNode, pannerNode;
async function startAudio(){
  if(audioCtx.state==='suspended') await audioCtx.resume();
  const N = audioCtx.sampleRate * 5;
  const buf = audioCtx.createBuffer(2, N, audioCtx.sampleRate);
  for(let ch=0;ch<2;ch++){
    const data = buf.getChannelData(ch);
    const white = Array.from({length:N},()=>Math.random()*2-1);
    let b0=0;
    const tau = 1 + Math.pow(10, phi/10); // 1/f^œÜ filter
    for(let i=0;i<N;i++){
      b0 = b0 + (white[i] - b0) / tau;
      data[i] = b0 * 0.5 * Math.sin(phi * i / audioCtx.sampleRate); // œÜ-mod phase
    }
  }
  bufferSource = audioCtx.createBufferSource();
  bufferSource.buffer = buf; bufferSource.loop = true;
  gainNode = audioCtx.createGain(); gainNode.gain.value = 0.15;
  pannerNode = audioCtx.createPanner(); pannerNode.setPosition(Math.sin(phi), 0, 1);
  bufferSource.connect(gainNode).connect(pannerNode).connect(audioCtx.destination);
  bufferSource.start();
  log('WebAudio: 1/f^œÜ streaming with œÜ-panning');
}
function stopAudio(){ if(bufferSource){ bufferSource.stop(); bufferSource=null; } }

// ---------- 5. WEBGL ----------
const gl = $('#webglCanvas').getContext('webgl2');
if(!gl){log('WebGL 2 not available ‚Äì 3-D sheet disabled'); $('#webglCanvas').style.display='none';}
else {
  const vertSrc = `#version 300 es
in vec2 aPos; in vec2 aUV; out vec2 vUV; uniform float uTime; void main(){
  vUV = aUV; float z = 0.1*sin(uTime + 2.0*aUV.x*1.62);
  gl_Position = vec4(aPos, z, 1.0);
}`;
  const fragSrc = `#version 300 es
precision highp float; in vec2 vUV; out vec4 fragColor; uniform float uTime;
void main(){
  vec2 p = vUV - 0.5; float r = length(p); float hue = 0.618 + 0.3*sin(uTime + r*10.0);
  vec3 col = 0.5 + 0.5*cos(6.28*(hue + vec3(0,1,2)/3.0)); float grid = step(0.05, mod(r*20.0,0.1));
  fragColor = vec4(col*(0.7+0.3*grid),1.0);
}`;
  function compileShader(src,type){
    const s = gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s);
    if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s));
    return s;
  }
  const prog = gl.createProgram();
  gl.attachShader(prog,compileShader(vertSrc,gl.VERTEX_SHADER));
  gl.attachShader(prog,compileShader(fragSrc,gl.FRAGMENT_SHADER));
  gl.linkProgram(prog); if(!gl.getProgramParameter(prog,gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(prog));
  gl.useProgram(prog);
  const verts = new Float32Array([-1,-1,0,0,  1,-1,1,0,  -1,1,0,1,  1,1,1,1]);
  const buf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf); gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW);
  const locPos=gl.getAttribLocation(prog,'aPos'), locUV=gl.getAttribLocation(prog,'aUV');
  gl.enableVertexAttribArray(locPos); gl.vertexAttribPointer(locPos,2,gl.FLOAT,false,16,0);
  gl.enableVertexAttribArray(locUV); gl.vertexAttribPointer(locUV,2,gl.FLOAT,false,16,8);
  const uTime = gl.getUniformLocation(prog,'uTime');
  function renderGL(t){
    gl.uniform1f(uTime,t*0.001); gl.drawArrays(gl.TRIANGLE_STRIP,0,4); requestAnimationFrame(renderGL);
  }
  requestAnimationFrame(renderGL);
  log('WebGL: œÜ-sheet scene running');
}

// ---------- 6. MAIN LOOP ----------
let sim, animId;
function start(runFake){
  $('#runBtn').disabled=true; $('#fakeBtn').disabled=true;
  log('Booting 9-Walls ‚Ä¶');
  try{
    const N = parseInt($('#N').value), dt=parseFloat($('#dt').value), L=parseInt($('#L').value);
    const alpha = runFake ? 1.0 : phi; // Fake: Œ±=1.0 for clear breach
    log(runFake ? 'Demo: trying Œ± = 1.0 ‚Ä¶' : 'Locking to œÜ ...');
    sim = new Walls9(N,dt,L, alpha);
    sim.psdFill();
    if($('#audioToggle').checked) startAudio();
    log(`‚úÖ RG fixed-point: Œ± = ${sim.alpha.toFixed(6)}, g* = ${sim.g.toFixed(6)}`);
    animId = requestAnimationFrame(loop);
  }catch(e){ log('‚ùå '+e.message); $('#runBtn').disabled=false; $('#fakeBtn').disabled=false; }
}
function loop(t){
  if(sim.t > sim.Tmax){
    try{ sim.checkBreaches(); }catch(e){ log('üö® '+e.message); }
    cancelAnimationFrame(animId);
    stopAudio();
    $('#runBtn').disabled=false; $('#fakeBtn').disabled=false;
    log('Run complete ‚Äì œÜ-audit passed?');
    return;
  }
  sim.step();
  drawGauge(ctxPhi, sim.dataHistory.phi, 'Œ¶*', '#4CAF50', 0, 0.15, '#phiVal');
  drawGauge(ctxBeta, sim.dataHistory.beta, 'Œ≤', '#FF9800', 0, 1, '#betaVal');
  drawGauge(ctxDet, sim.dataHistory.detg, 'det g', '#9C27B0', -0.002, 0, '#detgVal');
  drawGauge(ctxPSD, sim.psd, 'PSD (norm)', '#03A9F4', 0, 1, null);
  $('#slopeVal').textContent = sim.slope.toFixed(3); // Separate update
  requestAnimationFrame(loop);
}

// ---------- 7. HOOKS ----------
$('#runBtn').onclick = ()=>start(false);
$('#fakeBtn').onclick = ()=>start(true);
$('#audioToggle').onchange = async e=> e.target.checked ? await startAudio() : stopAudio();
$('#glToggle').onchange = e=> $('#webglCanvas').style.display = e.target.checked ? 'block':'none';
window.addEventListener('beforeunload', stopAudio);

// ---------- 8. WHITE-PAPER FETCH & CACHE ----------
const PAPER_URL = 'https://raw.githubusercontent.com/Ergo-sum-AGI/Dubito-AGI-Consciousness-Research-Papers/main/README.md'; // Fallback to repo README
const CACHE_KEY = '9walls_paper';
async function loadPaper(){
  let md = localStorage.getItem(CACHE_KEY);
  if(!md){
    try{
      const rsp = await fetch(PAPER_URL);
      if(!rsp.ok) throw 'network';
      md = await rsp.text();
      if(md.trim().length < 10) throw 'empty'; // Handle empty
      localStorage.setItem(CACHE_KEY, md);
      log('White-paper fetched & cached');
    }catch(e){
      md = `# 9-Walls Quest Overview\n\n## Abstract\nThe Golden Ratio œÜ as RG Fixed Point breaches 9 walls in CQFT: renormalizability, universality, decoherence suppression, etc. See full PDF: [Golden Ratio Paper](https://github.com/Ergo-sum-AGI/Dubito-AGI-Consciousness-Research-Papers/blob/main/Golden%20Ratio%20œÜ%20as%20a%20Renormalization%20Group%20Fixed%20Point%20Robustness%2C%20Universality%2C%20and%20Breaching%20the%209%20Walls.pdf)\n\n## Key Walls\n- Wall 1: œÜ-attractor in Œ≤(g)\n- Wall 6: 1/f^œÜ spectrum\n- Wall 9: Emergent Lorentzian det g <0`;
    }
  }else{ log('White-paper loaded from cache'); }
  const html = md
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    .replace(/\*\*(.+)\*\*/g, '<strong>$1</strong>')
    .replace(/\[(.+)\]\((.+)\)/g, '<a href="$2" target="_blank" style="color:gold;">$1</a>')
    .replace(/^\* (.+)/gim, '<li>$1</li>')
    .replace(/\n\n/g, '</p><p>').replace(/^<p>/, '<p>').replace(/<p>$/, '</p>');
  $('#paperBox').innerHTML = '<p>' + html.split('<p>').join('</p><p>') + '</p>'; // Wrap
}
loadPaper();

// ---------- 9. DOWNLOAD BUTTON ----------
$('#downloadBtn').onclick = ()=>{
  const md = localStorage.getItem(CACHE_KEY) || '*Paper not cached*';
  const blob = new Blob([md], {type:'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = '9walls_whitepaper.md'; a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>